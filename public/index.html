<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oposicion Tecnico Farmacia</title>
    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #fef7f0;
            min-height: 100vh;
            color: #374151;
            line-height: 1.6;
            font-weight: 400;
            overflow-x: hidden;
            width: 100%;
        }

        .container {
            max-width: 1050px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            color: #6b7280;
            margin-bottom: 40px;
            padding: 0 16px;
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
            color: #1f2937;
        }

        .header h1 .emoji {
            font-size: 3.5rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #9ca3af;
            font-weight: 300;
        }

        /* NAVEGACI√ìN PRINCIPAL */
        .main-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            max-width: 100%;
            overflow-x: hidden;
        }

        .nav-button {
            flex: 1;
            padding: 16px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .nav-button.active {
            background: #f97316;
            color: white;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .nav-button:hover:not(.active) {
            background: #f9fafb;
            color: #374151;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
            margin-bottom: 24px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .form-group {
            margin-bottom: 32px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 12px;
            color: #374151;
        }

        .select-wrapper {
            position: relative;
        }

        .form-select {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 16px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }

        .form-select:focus {
            outline: none;
            border-color: #f97316;
            background: white;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .start-button, .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.025em;
        }

        .start-button:hover:not(:disabled), .btn-primary:hover {
            background: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }

        .start-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        /* P√ÅGINAS */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ESTILOS DE LA PREGUNTA */
        .question-header {
            background: #f97316;
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .question-header h2 {
            font-size: 1.25rem;
            font-weight: 500;
        }

        .question-card {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
            border-top: none;
        }

        .question-text {
            font-size: 1.125rem;
            color: #1f2937;
            margin-bottom: 32px;
            line-height: 1.7;
            font-weight: 400;
        }

        .option {
            display: flex;
            align-items: flex-start;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
        }

        .option:hover {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.1);
        }

        .option.selected {
            border-color: #f97316;
            background: #fff7ed;
        }

        .option.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .option.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .option input[type="radio"] {
            margin-right: 16px;
            margin-top: 2px;
            transform: scale(1.1);
            accent-color: #f97316;
        }

        .option-text {
            flex: 1;
            line-height: 1.6;
            font-size: 1rem;
            color: #374151;
        }

        .result-section {
            margin-top: 32px;
            padding: 24px;
            border-radius: 12px;
            display: none;
        }

        .result-section.correct {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .result-section.incorrect {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .result-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .result-explanation {
            font-size: 1rem;
            line-height: 1.6;
            color: #4b5563;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.025em;
        }

        .btn-secondary {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        /* NOTIFICACIONES DE RETRY */
        .retry-notification {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .retry-notification.active {
            display: flex;
        }

        .retry-notification .icon {
            font-size: 1.5rem;
        }

        .retry-notification .content {
            flex: 1;
        }

        .retry-notification .title {
            font-weight: 600;
            color: #d97706;
            margin-bottom: 4px;
        }

        .retry-notification .message {
            color: #92400e;
            font-size: 0.875rem;
        }

        .retry-progress {
            width: 100%;
            height: 4px;
            background: #fde68a;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .retry-progress-bar {
            height: 100%;
            background: #f59e0b;
            width: 0%;
            transition: width 0.1s ease;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ESTAD√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e5e7eb;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .stat-badge {
            background: #f97316;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-badge.good {
            background: #10b981;
        }

        .stat-badge.warning {
            background: #f59e0b;
        }

        .stat-badge.danger {
            background: #ef4444;
        }

        .stat-numbers {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }

        .stat-number {
            text-align: center;
        }

        .stat-number .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-number .label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .progress-bar {
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #f97316;
        }

        .progress-fill.good {
            background: #10b981;
        }

        .progress-fill.warning {
            background: #f59e0b;
        }

        .progress-fill.danger {
            background: #ef4444;
        }

        .last-studied {
            font-size: 0.875rem;
            color: #9ca3af;
            text-align: center;
        }

        /* PREGUNTAS FALLADAS */
        .failed-topics {
            margin-top: 24px;
        }

        .failed-topic {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .failed-topic-header {
            background: #fef2f2;
            padding: 20px;
            border-bottom: 1px solid #fecaca;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .failed-topic-header:hover {
            background: #fde8e8;
        }

        .failed-topic-header h3 {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .failed-topic-count {
            color: #ef4444;
            font-size: 0.875rem;
        }

        .failed-questions {
            padding: 20px;
            display: none;
        }

        .failed-questions.active {
            display: block;
        }

        .failed-question {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafafa;
        }

        .failed-question-text {
            font-weight: 500;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .failed-question-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .retry-button {
            background: #f97316;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retry-button:hover {
            background: #ea580c;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #fecaca;
            text-align: center;
            font-size: 0.875rem;
        }

        .success-message {
            background: #f0fdf4;
            color: #16a34a;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #bbf7d0;
            text-align: center;
            font-size: 0.875rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        .emoji {
            font-size: 1.5rem;
            margin-right: 8px;
        }

        /* ESTADO DE SERVIDOR */
        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .server-status.online {
            background: #dcfce7;
            color: #166534;
        }

        .server-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* AUTENTICACI√ìN */
        .auth-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fef7f0;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-screen.active {
            display: flex;
        }

        .auth-container {
            max-width: 440px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 48px 40px;
            border: 1px solid #f3f4f6;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: #9ca3af;
            font-size: 1rem;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: #f9fafb;
            padding: 4px;
            border-radius: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .auth-tab.active {
            background: white;
            color: #f97316;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 8px;
            color: #374151;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: #fafafa;
            color: #374151;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #f97316;
            background: white;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .auth-button {
            width: 100%;
            padding: 14px 20px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .auth-button:hover:not(:disabled) {
            background: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .auth-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .auth-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.875rem;
            text-align: center;
            display: none;
        }

        .auth-message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }

        .auth-message.success {
            background: #f0fdf4;
            color: #065f46;
            border: 1px solid #bbf7d0;
            display: block;
        }

        .auth-message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
            display: block;
        }

        .logout-button {
            position: absolute;
            top: 24px;
            right: 24px;
            padding: 8px 16px;
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-button:hover {
            background: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }

        .user-info {
            display: inline-block;
            padding: 6px 12px;
            background: #fff7ed;
            color: #f97316;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: 12px;
        }

        @media (max-width: 768px) {
            .header {
                margin-bottom: 24px;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
                white-space: normal;
                overflow: hidden;
                word-wrap: break-word;
                line-height: 1.3;
            }

            .header h1 .emoji {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .card h2 {
                font-size: 1.1rem;
                white-space: normal;
                overflow: hidden;
                word-wrap: break-word;
            }

            .container {
                padding: 16px;
            }

            .card {
                padding: 24px;
            }

            .action-buttons, .main-nav {
                flex-direction: column;
            }

            .question-card {
                padding: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-numbers {
                gap: 16px;
            }

            .auth-container {
                padding: 32px 24px;
            }

            .logout-button {
                position: static;
                margin-top: 16px;
                width: 100%;
            }

            .user-info {
                display: block;
                margin: 8px auto 0;
                max-width: 90%;
                font-size: 0.75rem;
                padding: 4px 8px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Tabla responsive - Ocultar tabla desktop y mostrar vista m√≥vil */
            .topics-table-desktop {
                display: none !important;
            }

            .topics-table-mobile {
                display: block !important;
            }
        }

        /* ESTILOS PARA EXAMEN OFICIAL */
        .exam-size-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .exam-size-btn:hover {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
        }

        .exam-size-btn.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-color: #f97316;
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE AUTENTICACI√ìN -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üìö Oposiciones</h1>
                <p>Accede a tu cuenta para estudiar</p>
            </div>

            <div id="auth-message" class="auth-message"></div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')" id="tab-login">
                    Iniciar Sesi√≥n
                </button>
                <button class="auth-tab" onclick="switchAuthTab('register')" id="tab-register">
                    Registrarse
                </button>
            </div>

            <!-- FORMULARIO DE LOGIN -->
            <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="auth-input-group">
                    <label for="login-username">Usuario</label>
                    <input
                        type="text"
                        id="login-username"
                        class="auth-input"
                        placeholder="Ingresa tu usuario"
                        required
                        autocomplete="username"
                    >
                </div>
                <div class="auth-input-group">
                    <label for="login-password">Contrase√±a</label>
                    <input
                        type="password"
                        id="login-password"
                        class="auth-input"
                        placeholder="Ingresa tu contrase√±a"
                        required
                        autocomplete="current-password"
                    >
                </div>
                <button type="submit" class="auth-button" id="login-btn">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <!-- FORMULARIO DE REGISTRO -->
            <form id="register-form" class="auth-form" onsubmit="handleRegister(event)">
                <div class="auth-input-group">
                    <label for="register-username">Usuario</label>
                    <input
                        type="text"
                        id="register-username"
                        class="auth-input"
                        placeholder="Elige un usuario (m√≠n. 3 caracteres)"
                        minlength="3"
                        required
                        autocomplete="username"
                    >
                </div>
                <div class="auth-input-group">
                    <label for="register-password">Contrase√±a</label>
                    <input
                        type="password"
                        id="register-password"
                        class="auth-input"
                        placeholder="Elige una contrase√±a (m√≠n. 6 caracteres)"
                        minlength="6"
                        required
                        autocomplete="new-password"
                    >
                </div>
                <div class="auth-input-group">
                    <label for="register-password-confirm">Confirmar Contrase√±a</label>
                    <input
                        type="password"
                        id="register-password-confirm"
                        class="auth-input"
                        placeholder="Repite tu contrase√±a"
                        minlength="6"
                        required
                        autocomplete="new-password"
                    >
                </div>
                <button type="submit" class="auth-button" id="register-btn">
                    Crear Cuenta
                </button>
                <p style="margin-top: 16px; font-size: 0.875rem; color: #6b7280; text-align: center;">
                    Tu cuenta quedar√° bloqueada hasta que el administrador la active.
                </p>
            </form>
        </div>
    </div>

    <div class="container" id="main-app" style="display: none;">
        <button class="logout-button" onclick="handleLogout()" id="logout-btn" style="display: none;">
            üö™ Cerrar Sesi√≥n
        </button>

        <div class="header">
            <h1>
                <span class="emoji">üìö</span>T√©cnicos de Farmacia
                <span id="user-info" class="user-info" style="display: none;"></span>
            </h1>
            <div id="server-status" class="server-status offline">
                <div class="status-indicator"></div>
                <span>Verificando servidor...</span>
            </div>
        </div>

        <!-- NAVEGACI√ìN PRINCIPAL -->
        <nav class="main-nav">
            <button class="nav-button active" onclick="showPage('study')" id="nav-study">
                üìù Estudiar
            </button>
            <button class="nav-button" onclick="showPage('progress')" id="nav-progress">
                üìä Ver Avance
            </button>
            <button class="nav-button" onclick="showPage('review')" id="nav-review">
                üîÑ Reforzar
            </button>
            <button class="nav-button" onclick="showPage('official-exam')" id="nav-official-exam">
                üéì Examen Oficial
            </button>
        </nav>

        <!-- NOTIFICACI√ìN DE REINTENTOS -->
        <div id="retry-notification" class="retry-notification">
            <div class="icon">üîÑ</div>
            <div class="content">
                <div class="title">Reintentando generar pregunta...</div>
                <div class="message" id="retry-message">Claude est√° temporalmente ocupado. La aplicaci√≥n reintentar√° autom√°ticamente.</div>
                <div class="retry-progress">
                    <div class="retry-progress-bar" id="retry-progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA DE ESTUDIO -->
        <div id="study-page" class="page active">
            <!-- SELECCI√ìN DE TEMA -->
            <div id="topic-selection" class="card">
                <div class="form-group">
                    <label for="topic-select">Selecciona un tema para estudiar</label>
                    <div class="select-wrapper">
                        <select id="topic-select" class="form-select">
                            <option value="">Cargando temas disponibles...</option>
                        </select>
                    </div>
                </div>

                <button class="start-button" onclick="startStudying()" id="start-btn" disabled>
                    Comenzar a estudiar
                </button>
                
                <div id="error-container"></div>
            </div>

            <div class="card" id="available-topics">
                <p>Cargando informaci√≥n de temas...</p>
            </div>

            <!-- PREGUNTA -->
            <div id="question-container" class="hidden">
                <div class="question-header">
                    <div id="current-topic-name">Tema Actual</div>
                    <div id="question-number">Pregunta 1</div>
                </div>

                <!-- Barra de progreso para examen oficial -->
                <div id="exam-progress-bar" style="display: none; background: #f3f4f6; border-radius: 8px; overflow: hidden; margin: 16px 0; height: 8px;">
                    <div id="exam-progress-fill" style="height: 100%; background: linear-gradient(90deg, #f97316 0%, #ea580c 100%); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="exam-progress-text" style="display: none; text-align: center; color: #6b7280; font-size: 0.875rem; margin-bottom: 16px;">
                    <span id="exam-progress-current">0</span> de <span id="exam-progress-total">0</span> preguntas respondidas
                </div>

                <!-- Bot√≥n Finalizar Examen (solo cuando termine todas) -->
                <div id="exam-finish-container" style="display: none; margin-bottom: 16px;">
                    <button onclick="showFinishExamModal()" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 1.125rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                        ‚úÖ Finalizar Examen y Ver Resultados
                    </button>
                </div>

                <div class="question-card">
                    <div class="question-text" id="question-text">
                        Cargando pregunta...
                    </div>
                    
                    <div id="options-container">
                        <!-- Las opciones se cargar√°n aqu√≠ -->
                    </div>
                    
                    <div class="result-section" id="result-section">
                        <div class="result-icon" id="result-icon"></div>
                        <div class="result-title" id="result-title"></div>
                        <div class="result-explanation" id="result-explanation"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="backToTopicSelection()">
                            <span class="emoji">üè†</span> Volver al inicio
                        </button>
                        <button class="btn btn-primary" id="next-question-btn" onclick="generateNextQuestion()" style="display: none;">
                            Siguiente pregunta <span class="emoji">‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA DE PROGRESO -->
        <div id="progress-page" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2><span class="emoji">üìä</span>Tu Progreso</h2>
                    <button onclick="clearAllData()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                        üóëÔ∏è Limpiar datos
                    </button>
                </div>
                <p style="color: #6b7280; margin-top: 8px;">Revisa tu rendimiento en cada tema</p>
            </div>

            <div id="stats-container">
                <div class="empty-state">
                    <div class="emoji">üìà</div>
                    <h3>¬°Comienza a estudiar!</h3>
                    <p>Aqu√≠ ver√°s tus estad√≠sticas una vez que respondas algunas preguntas.</p>
                </div>
            </div>

            <!-- Bot√≥n Estad√≠sticas Semanales PDF -->
            <div style="margin-top: 24px; text-align: center;">
                <button onclick="showWeeklyStatsModal()" style="background: #3b82f6; color: white; padding: 14px 28px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.background='#3b82f6'; this.style.transform='none'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)';">
                    üìä Descargar Estad√≠sticas Semanales (PDF)
                </button>
            </div>
        </div>

        <!-- P√ÅGINA DE REPASO -->
        <div id="review-page" class="page">
            <div id="failed-container">
                <div class="empty-state">
                    <div class="emoji">üéØ</div>
                    <h3>¬°Excelente!</h3>
                    <p>No tienes preguntas falladas para repasar. Sigue practicando para mantener tu nivel.</p>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA: EXAMEN OFICIAL -->
        <div id="official-exam-page" class="page">
            <div class="card">
                <h3 style="margin-bottom: 16px; color: #1f2937;">‚öôÔ∏è Configurar Examen</h3>

                <!-- Banner Examen Pendiente -->
                <div id="pending-exam-banner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                        <div style="font-size: 2.5rem;">üìù</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.125rem; color: white; margin-bottom: 4px;">¬°Tienes un Examen Pendiente!</div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.875rem;" id="pending-exam-info">
                                Respondiste X de Y preguntas
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button onclick="continueOfficialExam()" style="background: white; color: #059669; padding: 12px 20px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;">
                            ‚úÖ Continuar Examen
                        </button>
                        <button onclick="cancelPendingExam()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 20px; font-weight: 600; border: 1px solid white; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;">
                            ‚ùå Cancelar y Empezar Nuevo
                        </button>
                    </div>
                </div>

                <!-- Selector de Preguntas -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #374151;">
                        üìù N√∫mero de Preguntas
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <button class="exam-size-btn active" data-size="25" onclick="selectExamSize(25)">
                            <div style="font-size: 1.5rem; font-weight: bold;">25</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">R√°pido</div>
                        </button>
                        <button class="exam-size-btn" data-size="50" onclick="selectExamSize(50)">
                            <div style="font-size: 1.5rem; font-weight: bold;">50</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Medio</div>
                        </button>
                        <button class="exam-size-btn" data-size="75" onclick="selectExamSize(75)">
                            <div style="font-size: 1.5rem; font-weight: bold;">75</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Largo</div>
                        </button>
                        <button class="exam-size-btn" data-size="100" onclick="selectExamSize(100)">
                            <div style="font-size: 1.5rem; font-weight: bold;">100</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Completo</div>
                        </button>
                    </div>
                </div>

                <!-- Informaci√≥n del Examen -->
                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Modo Examen Real</div>
                            <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 0.875rem; line-height: 1.6;">
                                <li>Preguntas mezcladas de <strong>todos los temas</strong></li>
                                <li>No podr√°s volver a preguntas anteriores</li>
                                <li>No ver√°s las respuestas hasta el final</li>
                                <li>Las preguntas falladas se guardar√°n en <strong>Reforzar</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Iniciar -->
                <button id="start-exam-btn" onclick="startOfficialExam()" style="width: 100%; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 16px 32px; font-size: 1.125rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(249, 115, 22, 0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 12px rgba(249, 115, 22, 0.3)';">
                    üöÄ Iniciar Examen Oficial
                </button>
                <div id="exam-loading" style="display: none; text-align: center; margin-top: 16px; padding: 24px; background: #fff7ed; border-radius: 12px; border: 2px solid #f97316;">
                    <div class="loading" style="margin: 0 auto 16px;"></div>
                    <div style="font-weight: 600; color: #f97316; margin-bottom: 8px;">Generando Examen Oficial</div>
                    <div style="font-size: 0.875rem; color: #9a3412;">Esto puede tardar 1-2 minutos. Por favor espera...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTopic = null;
        let currentQuestion = null;
        let questionCount = 0;
        let correctAnswers = 0;
        let availableTopics = [];
        let userStats = {};
        let failedQuestions = {};
        let isServerOnline = false;
        let retryAttempt = 0;
        let maxRetryAttempts = 3;
        const API_BASE = '';
        let currentUser = null;
        let isAuthenticated = false;

        // Variables para Examen Oficial
        let officialExamConfig = {
            questionCount: 25
        };
        let officialExamQuestions = [];
        let isOfficialExamMode = false;
        let officialExamStartTime = null;
        let officialExamAnswers = [];

        // ========================
        // SISTEMA DE AUTENTICACI√ìN
        // ========================

        async function checkAuth() {
            console.log('üîê Verificando autenticaci√≥n...');
            try {
                const response = await fetch(`${API_BASE}/api/auth/check`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('üì° Respuesta auth/check:', {
                    status: response.status,
                    ok: response.ok
                });

                const data = await response.json();
                console.log('üì¶ Datos de autenticaci√≥n:', data);

                if (data.authenticated) {
                    if (data.blocked) {
                        console.warn('‚ö†Ô∏è Usuario bloqueado');
                        showAuthScreen();
                        showAuthMessage('error', 'Tu cuenta est√° bloqueada. Contacta al administrador para reactivarla.');
                        return false;
                    }

                    isAuthenticated = true;
                    currentUser = data.user;
                    console.log('‚úÖ Usuario autenticado:', currentUser);
                    showMainApp();
                    return true;
                } else {
                    console.log('‚ùå No autenticado');
                    showAuthScreen();
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error verificando autenticaci√≥n:', error);
                showAuthScreen();
                return false;
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.getElementById('tab-login').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.getElementById('tab-register').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }

            // Limpiar mensajes
            showAuthMessage();
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');

            btn.disabled = true;
            btn.textContent = 'Iniciando sesi√≥n...';

            console.log('üîë Intentando login con usuario:', username);

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('üì° Respuesta login:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                const data = await response.json();
                console.log('üì¶ Datos login:', data);

                if (response.ok) {
                    console.log('‚úÖ Login exitoso!');
                    currentUser = data.user;
                    isAuthenticated = true;
                    showMainApp();

                    // Cargar datos del usuario desde el servidor
                    await loadUserData();

                    // IMPORTANTE: Verificar servidor despu√©s de login
                    await checkServerHealth();
                    await loadAvailableTopics();
                } else {
                    console.error('‚ùå Login fall√≥:', data.error);
                    showAuthMessage('error', data.error || 'Error al iniciar sesi√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error en login (excepci√≥n):', error);
                showAuthMessage('error', 'Error de conexi√≥n. Intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const btn = document.getElementById('register-btn');

            if (password !== passwordConfirm) {
                showAuthMessage('error', 'Las contrase√±as no coinciden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creando cuenta...';

            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.requiresActivation) {
                        showAuthMessage('warning', 'Cuenta creada. Espera a que el administrador la active para poder acceder.');
                        // Cambiar a tab de login despu√©s de 3 segundos
                        setTimeout(() => {
                            switchAuthTab('login');
                        }, 3000);
                    } else {
                        showAuthMessage('success', 'Cuenta creada exitosamente');
                    }

                    // Limpiar formulario
                    document.getElementById('register-form').reset();
                } else {
                    showAuthMessage('error', data.error || 'Error al crear cuenta');
                }
            } catch (error) {
                console.error('Error en registro:', error);
                showAuthMessage('error', 'Error de conexi√≥n. Intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Crear Cuenta';
            }
        }

        async function handleLogout() {
            if (!confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                return;
            }

            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                isAuthenticated = false;
                currentUser = null;
                userStats = {};
                failedQuestions = {};

                showAuthScreen();
                showAuthMessage('success', 'Sesi√≥n cerrada correctamente');
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        }

        function showAuthScreen() {
            document.getElementById('auth-screen').classList.add('active');
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('user-info').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('auth-screen').classList.remove('active');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'block';

            if (currentUser) {
                const userInfoElement = document.getElementById('user-info');
                userInfoElement.textContent = currentUser.username;
                userInfoElement.style.display = 'inline-block';
            }
        }

        function showAuthMessage(type, message) {
            const messageElement = document.getElementById('auth-message');

            if (!type || !message) {
                messageElement.className = 'auth-message';
                messageElement.textContent = '';
                return;
            }

            messageElement.className = `auth-message ${type}`;
            messageElement.textContent = message;
        }

        async function loadUserData() {
            try {
                // Cargar estad√≠sticas del usuario desde el servidor
                const statsResponse = await fetch(`${API_BASE}/api/user-stats`, {
                    credentials: 'include'
                });

                if (statsResponse.ok) {
                    userStats = await statsResponse.json();
                    displayStats();
                }

                // Cargar preguntas falladas del usuario desde el servidor
                const failedResponse = await fetch(`${API_BASE}/api/failed-questions`, {
                    credentials: 'include'
                });

                if (failedResponse.ok) {
                    failedQuestions = await failedResponse.json();
                    displayFailedQuestions();
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
            }
        }

        // ========================
        // VERIFICACI√ìN DEL SERVIDOR
        // ========================

        async function checkServerHealth() {
            console.log('üîç Verificando servidor...');
            updateServerStatus('checking', 'Verificando servidor...');

            try {
                const response = await fetch(`${API_BASE}/api/health`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('üì° Respuesta del servidor:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                if (response.ok) {
                    const health = await response.json();
                    updateServerStatus('online', 'Servidor en l√≠nea');
                    isServerOnline = true;
                    console.log('‚úÖ Servidor disponible:', health);
                    return true;
                } else {
                    console.error('‚ùå Respuesta no OK:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('‚ùå Error conectando al servidor:', error);
                console.error('Error completo:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }

            updateServerStatus('offline', 'Modo demostraci√≥n');
            isServerOnline = false;
            return false;
        }

        function updateServerStatus(status, message) {
            const statusElement = document.getElementById('server-status');
            statusElement.className = `server-status ${status}`;
            statusElement.innerHTML = `
                <div class="status-indicator"></div>
                <span>${message}</span>
            `;
        }

        // ========================
        // SISTEMA DE REINTENTOS
        // ========================

        function showRetryNotification(attempt, maxAttempts, message) {
            const notification = document.getElementById('retry-notification');
            const messageElement = document.getElementById('retry-message');
            const progressBar = document.getElementById('retry-progress-bar');
            
            notification.classList.add('active');
            messageElement.textContent = `${message} (Intento ${attempt}/${maxAttempts})`;
            
            const progressPercentage = (attempt / maxAttempts) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function hideRetryNotification() {
            const notification = document.getElementById('retry-notification');
            notification.classList.remove('active');
            retryAttempt = 0;
        }

        async function generateQuestionWithRetry() {
            retryAttempt = 0;
            
            while (retryAttempt < maxRetryAttempts) {
                retryAttempt++;
                
                if (retryAttempt > 1) {
                    showRetryNotification(retryAttempt, maxRetryAttempts, 'Reintentando...');
                    const waitTime = Math.min(2000 * Math.pow(2, retryAttempt - 2), 10000);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                try {
                    // FASE 2: Usar endpoint con prefetch para respuestas instant√°neas
                    const response = await fetch(`${API_BASE}/api/study/question`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            topicId: currentTopic
                        }),
                    });

                    if (response.status === 401 || response.status === 403) {
                        // Sesi√≥n expirada o cuenta bloqueada
                        isAuthenticated = false;
                        currentUser = null;
                        showAuthScreen();
                        const errorData = await response.json();
                        showAuthMessage('error', errorData.error || 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                        return false;
                    }

                    if (response.ok) {
                        const data = await response.json();

                        if (data.questions && data.questions.length > 0) {
                            currentQuestion = data.questions[0];

                            // FASE 2: Log de informaci√≥n del buffer
                            if (data.source === 'buffer') {
                                console.log('‚ö° Pregunta INSTANT√ÅNEA desde buffer');
                            } else if (data.source === 'generated') {
                                console.log('üî® Batch de 5 preguntas generado');
                            }
                            console.log(`üíæ Buffer: ${data.bufferSize} preguntas listas`);

                            hideRetryNotification();
                            displayQuestion();
                            return true;
                        }
                    } else if (response.status === 503 || response.status === 429) {
                        const errorData = await response.json();
                        console.log(`‚è≥ Error ${response.status}: ${errorData.error}`);

                        if (retryAttempt < maxRetryAttempts) {
                            showRetryNotification(retryAttempt, maxRetryAttempts, errorData.error || 'Servidor ocupado');
                            continue;
                        }
                    } else {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error(`‚ùå Intento ${retryAttempt} fallido:`, error);
                    
                    if (retryAttempt < maxRetryAttempts) {
                        showRetryNotification(retryAttempt, maxRetryAttempts, 'Error de conexi√≥n');
                        continue;
                    }
                }
            }
            
            hideRetryNotification();
            showError('‚ö†Ô∏è No se pudieron generar preguntas en este momento. El servicio est√° experimentando alta demanda. Por favor, recarga la p√°gina e intenta de nuevo en unos momentos.');
            return false;
        }

        // ========================
        // PERSISTENCIA DE DATOS
        // ========================

        function saveUserStats() {
            try {
                localStorage.setItem('oposicion_stats', JSON.stringify(userStats));
                console.log('üìä Estad√≠sticas guardadas');
            } catch (error) {
                console.error('Error guardando estad√≠sticas:', error);
            }
        }

        function loadUserStatsFromLocal() {
            try {
                const saved = localStorage.getItem('oposicion_stats');
                if (saved) {
                    userStats = JSON.parse(saved);
                    console.log('üìä Estad√≠sticas cargadas');
                } else {
                    userStats = {};
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                userStats = {};
            }
        }

        function saveFailedQuestions() {
            try {
                localStorage.setItem('oposicion_failed', JSON.stringify(failedQuestions));
                console.log('‚ùå Preguntas falladas guardadas');
            } catch (error) {
                console.error('Error guardando preguntas falladas:', error);
            }
        }

        function loadFailedQuestionsFromLocal() {
            try {
                const saved = localStorage.getItem('oposicion_failed');
                if (saved) {
                    failedQuestions = JSON.parse(saved);
                    console.log('‚ùå Preguntas falladas cargadas');
                } else {
                    failedQuestions = {};
                }
            } catch (error) {
                console.error('Error cargando preguntas falladas:', error);
                failedQuestions = {};
            }
        }

        async function updateLocalStats(topicId, isCorrect, isReview = false, questionId = null) {
            const topicConfig = availableTopics.find(([id]) => id === topicId);
            const topicTitle = topicConfig ? topicConfig[1].title : 'Tema desconocido';

            // Si es modo repaso, no actualizar estad√≠sticas locales
            if (!isReview) {
                if (!userStats[topicId]) {
                    userStats[topicId] = {
                        title: topicTitle,
                        totalQuestions: 0,
                        correctAnswers: 0,
                        lastStudied: new Date().toISOString()
                    };
                }

                userStats[topicId].totalQuestions++;
                if (isCorrect) {
                    userStats[topicId].correctAnswers++;
                }
                userStats[topicId].lastStudied = new Date().toISOString();
                userStats[topicId].accuracy = Math.round((userStats[topicId].correctAnswers / userStats[topicId].totalQuestions) * 100);
            }

            // Enviar al servidor
            try {
                const requestBody = {
                    topicId,
                    questionData: currentQuestion,
                    userAnswer: null,
                    isCorrect
                };

                // Agregar par√°metros de repaso si aplica
                if (isReview && questionId) {
                    requestBody.isReview = true;
                    requestBody.questionId = questionId;
                }

                const response = await fetch(`${API_BASE}/api/record-answer`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                }

                if (response.ok) {
                    console.log(isReview ? '‚úÖ Pregunta de repaso procesada' : '‚úÖ Estad√≠sticas guardadas en servidor');

                    // Si es repaso y fue correcta, actualizar la lista local
                    if (isReview && isCorrect && questionId) {
                        if (failedQuestions[topicId]) {
                            failedQuestions[topicId].questions = failedQuestions[topicId].questions.filter(q => q.id !== questionId);
                            if (failedQuestions[topicId].questions.length === 0) {
                                delete failedQuestions[topicId];
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error guardando datos:', error);
            }
        }

        async function addLocalFailedQuestion(topicId, questionData, userAnswer) {
            const topicConfig = availableTopics.find(([id]) => id === topicId);
            const topicTitle = topicConfig ? topicConfig[1].title : 'Tema desconocido';

            // Actualizar localmente primero
            if (!failedQuestions[topicId]) {
                failedQuestions[topicId] = {
                    title: topicTitle,
                    questions: []
                };
            }

            const failedQuestion = {
                ...questionData,
                userAnswer,
                date: new Date().toISOString(),
                id: Date.now() + Math.random()
            };

            failedQuestions[topicId].questions.push(failedQuestion);

            // Enviar al servidor
            try {
                const response = await fetch(`${API_BASE}/api/record-answer`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topicId,
                        questionData,
                        userAnswer,
                        isCorrect: false
                    })
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                }

                if (response.ok) {
                    console.log('‚úÖ Pregunta fallada guardada en servidor');
                }
            } catch (error) {
                console.error('Error guardando pregunta fallada:', error);
            }
        }

        async function removeLocalFailedQuestion(topicId, questionId) {
            // Actualizar localmente primero
            if (failedQuestions[topicId]) {
                failedQuestions[topicId].questions = failedQuestions[topicId].questions.filter(q => q.id !== questionId);

                if (failedQuestions[topicId].questions.length === 0) {
                    delete failedQuestions[topicId];
                }
            }

            // Enviar al servidor
            try {
                const response = await fetch(`${API_BASE}/api/resolve-failed-question`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionId })
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                }

                if (response.ok) {
                    console.log('‚úÖ Pregunta resuelta guardada en servidor');
                }
            } catch (error) {
                console.error('Error marcando pregunta como repasada:', error);
            }
        }

        // ========================
        // NAVEGACI√ìN
        // ========================

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${pageName}-page`).classList.add('active');
            document.getElementById(`nav-${pageName}`).classList.add('active');

            switch(pageName) {
                case 'study':
                    // Asegurar que la selecci√≥n de temas est√© visible
                    document.getElementById('topic-selection').style.display = 'block';
                    document.getElementById('available-topics').style.display = 'block';
                    document.getElementById('question-container').classList.add('hidden');

                    // üî¥ FIX: Si NO est√° en modo examen, ocultar barra de progreso
                    if (!isOfficialExamMode) {
                        document.getElementById('exam-progress-bar').style.display = 'none';
                        document.getElementById('exam-progress-text').style.display = 'none';
                        document.getElementById('exam-finish-container').style.display = 'none';
                    }

                    loadAvailableTopics();
                    break;
                case 'progress':
                    displayStats();
                    break;
                case 'review':
                    displayFailedQuestions();
                    break;
                case 'official-exam':
                    checkPendingExam();
                    break;
            }
        }

        function showQuestionMode() {
            document.getElementById('topic-selection').style.display = 'none';
            document.getElementById('available-topics').style.display = 'none';
            document.getElementById('question-container').classList.remove('hidden');
        }

        async function backToTopicSelection() {
            // Detectar desde qu√© modo venimos
            const wasReviewMode = window.isReviewMode === true;
            const wasExamMode = isOfficialExamMode === true;

            // Ocultar contenedor de preguntas
            document.getElementById('question-container').classList.add('hidden');
            hideRetryNotification();

            // Si est√°bamos en modo repaso
            if (wasReviewMode) {
                window.isReviewMode = false;
                window.reviewQuestions = null;
                window.currentReviewIndex = 0;
                await loadUserData();
                showPage('review'); // Volver a p√°gina Reforzar
                return;
            }

            // Si est√°bamos en modo examen oficial
            if (wasExamMode) {
                showPage('official-exam'); // Volver a p√°gina Examen Oficial
                return;
            }

            // Si est√°bamos en modo estudio normal, volver a selecci√≥n de temas
            document.getElementById('topic-selection').style.display = 'block';
            document.getElementById('available-topics').style.display = 'block';
            loadAvailableTopics();
        }

        // ========================
        // CARGA DE TEMAS
        // ========================

        async function loadAvailableTopics() {
            try {
                console.log('üîÑ Cargando temas...');
                console.log('üìä Estado del servidor: isServerOnline =', isServerOnline);

                if (!isServerOnline) {
                    console.log('‚ö†Ô∏è Servidor offline, cargando temas demo');
                    loadDemoTopics();
                    return;
                }

                console.log('üì° Llamando a /api/documents-status...');
                const response = await fetch(`${API_BASE}/api/documents-status`, {
                    credentials: 'include'
                });

                console.log('üì° Respuesta documents-status:', {
                    status: response.status,
                    ok: response.ok
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const status = await response.json();
                console.log('üì¶ Temas recibidos:', Object.keys(status).length);

                availableTopics = Object.entries(status).filter(([id, config]) =>
                    config.files && config.files.some(file => file.exists)
                );

                console.log('‚úÖ Temas disponibles filtrados:', availableTopics.length);
                populateTopicSelect();
                updateTopicInfo();

            } catch (error) {
                console.error('‚ùå Error cargando temas:', error);
                loadDemoTopics();
            }
        }

        function loadDemoTopics() {
            availableTopics = [
                ['demo-tema-14', { title: 'TEMA 14 - LOPJ (Demo)' }],
                ['demo-constitucional', { title: 'Derecho Constitucional (Demo)' }],
                ['demo-civil', { title: 'Procedimiento Civil (Demo)' }]
            ];
            
            populateTopicSelect();
            updateTopicInfo();
        }

        function populateTopicSelect() {
            const select = document.getElementById('topic-select');
            select.innerHTML = '<option value="">Selecciona un tema...</option>';
            
            availableTopics.forEach(([id, config]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = config.title;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                const startBtn = document.getElementById('start-btn');
                startBtn.disabled = !this.value;
            });
        }

        function updateTopicInfo() {
            const infoText = isServerOnline ? 
                `${availableTopics.length} temas disponibles` :
                `‚ö†Ô∏è Modo demostraci√≥n - ${availableTopics.length} temas de prueba`;
            
            document.getElementById('available-topics').innerHTML = 
                `<p style="text-align: center; color: ${isServerOnline ? '#6b7280' : '#dc2626'};">${infoText}</p>`;
        }

        // ========================
        // INICIO DEL ESTUDIO
        // ========================

        function startStudying() {
            const select = document.getElementById('topic-select');
            const selectedTopicId = select.value;

            if (!selectedTopicId) {
                showError('Por favor selecciona un tema');
                return;
            }

            // üî¥ FIX: Asegurar que NO estamos en modo examen
            isOfficialExamMode = false;
            officialExamQuestions = [];
            officialExamAnswers = [];

            // üî¥ FIX: Ocultar elementos de progreso del examen oficial
            document.getElementById('exam-progress-bar').style.display = 'none';
            document.getElementById('exam-progress-text').style.display = 'none';
            document.getElementById('exam-finish-container').style.display = 'none';

            currentTopic = selectedTopicId;

            const topicConfig = availableTopics.find(([id]) => id === selectedTopicId);
            const topicTitle = topicConfig ? topicConfig[1].title : 'Tema Demo';

            document.getElementById('current-topic-name').textContent = topicTitle;
            questionCount = 0;
            correctAnswers = 0;

            // FASE 3: Pre-warming - generar preguntas en background
            preWarmBuffer(selectedTopicId);

            showQuestionMode();
            generateNextQuestion();
        }

        // ========================
        // FASE 3: PRE-WARMING
        // ========================

        async function preWarmBuffer(topicId) {
            try {
                console.log(`üî• FASE 3: Pre-warming buffer para ${topicId}...`);

                const response = await fetch(`${API_BASE}/api/study/pre-warm`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topicId: topicId })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`‚úÖ Pre-warming: ${data.message} (Buffer: ${data.bufferSize})`);
                } else {
                    console.warn('‚ö†Ô∏è Pre-warming fall√≥, continuando normal');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en pre-warming:', error);
                // No bloquear si pre-warm falla
            }
        }

        // ========================
        // GENERACI√ìN DE PREGUNTAS
        // ========================

        async function generateNextQuestion() {
            // SI ES MODO EXAMEN OFICIAL
            if (isOfficialExamMode && officialExamQuestions.length > 0) {
                // Si ya respondi√≥ todas las preguntas
                if (questionCount >= officialExamQuestions.length) {
                    finishOfficialExam();
                    return;
                }

                // Mostrar siguiente pregunta
                questionCount++;
                currentQuestion = officialExamQuestions[questionCount - 1];
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${officialExamQuestions.length}`;
                displayQuestion();
                return;
            }

            if (!currentTopic) return;

            // Si estamos en modo repaso, navegar por las preguntas del test
            if (window.isReviewMode && window.reviewQuestions) {
                window.currentReviewIndex++;

                // Si llegamos al final del test de repaso
                if (window.currentReviewIndex >= window.reviewQuestions.length) {
                    // Finalizar test de repaso
                    window.isReviewMode = false;
                    window.reviewQuestions = null;
                    window.currentReviewIndex = 0;

                    // Recargar preguntas falladas
                    await loadUserData();

                    // Volver a la p√°gina de repaso
                    alert(`¬°Test de repaso completado!\n\nAcertadas: ${correctAnswers} de ${questionCount}`);
                    backToTopicSelection();
                    showPage('review');
                    return;
                }

                // Mostrar siguiente pregunta de repaso
                currentQuestion = window.reviewQuestions[window.currentReviewIndex];
                questionCount++;
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${window.reviewQuestions.length}`;
                displayQuestion();
                return;
            }

            // Modo normal: generar pregunta desde la API
            questionCount++;
            document.getElementById('question-number').textContent = `Pregunta ${questionCount}`;

            showLoading();

            if (isServerOnline) {
                await generateQuestionWithRetry();
            } else {
                setTimeout(() => {
                    showDemoQuestion();
                }, 1000);
            }
        }

        function showDemoQuestion() {
            // Ya no mostramos preguntas demo - mostramos error claro
            // Esta funci√≥n se mantiene por compatibilidad pero ya no genera preguntas
            console.error('‚ùå showDemoQuestion() llamada - el servicio no pudo generar preguntas');
        }

        function displayQuestion() {
            document.getElementById('question-text').textContent = currentQuestion.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(index);
                
                optionDiv.innerHTML = `
                    <input type="radio" name="question-option" id="option-${index}" value="${index}">
                    <div class="option-text">${option}</div>
                `;
                
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'none';
        }

        function selectOption(optionIndex) {
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });

            const selectedOption = document.querySelectorAll('.option')[optionIndex];
            selectedOption.classList.add('selected');
            document.getElementById(`option-${optionIndex}`).checked = true;

            // SI ES MODO EXAMEN OFICIAL: guardar respuesta y pasar a siguiente sin mostrar resultado
            if (isOfficialExamMode) {
                saveOfficialExamAnswer(optionIndex);
                // Peque√±o delay para feedback visual de selecci√≥n
                setTimeout(() => {
                    generateNextQuestion();
                }, 300);
            } else {
                // MODO NORMAL: mostrar resultado inmediatamente
                showResult(optionIndex);
            }
        }

        async function showResult(userAnswer) {
            const isCorrect = userAnswer === currentQuestion.correct;

            if (isCorrect) correctAnswers++;

            // Detectar si estamos en modo repaso
            const isReview = window.isReviewMode === true;
            const questionId = isReview ? currentQuestion.id : null;

            // SI ES MODO EXAMEN OFICIAL
            if (isOfficialExamMode) {
                // Guardar respuesta en el array
                officialExamAnswers.push({
                    questionNumber: questionCount,
                    question: currentQuestion.question,
                    userAnswer,
                    correctAnswer: currentQuestion.correct,
                    isCorrect,
                    timestamp: Date.now()
                });

                // NO actualizar estad√≠sticas ni preguntas falladas en modo oficial
            } else {
                // MODO NORMAL O REPASO
                // Actualizar estad√≠sticas (o marcar como revisada si es repaso)
                await updateLocalStats(currentTopic, isCorrect, isReview, questionId);

                // Solo agregar a preguntas falladas si NO es modo repaso
                if (!isCorrect && !isReview) {
                    await addLocalFailedQuestion(currentTopic, currentQuestion, userAnswer);
                }
            }

            document.querySelectorAll('.option').forEach((opt, index) => {
                if (index === currentQuestion.correct) {
                    opt.classList.add('correct');
                } else if (index === userAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            const resultSection = document.getElementById('result-section');
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            const resultExplanation = document.getElementById('result-explanation');

            if (isCorrect) {
                resultSection.className = 'result-section correct';
                resultIcon.textContent = '‚úÖ';
                resultTitle.textContent = isReview ? '¬°Correcto! Pregunta eliminada del repaso.' : '¬°Correcto!';
                resultTitle.style.color = '#16a34a';
            } else {
                resultSection.className = 'result-section incorrect';
                resultIcon.textContent = '‚ùå';
                resultTitle.textContent = isReview ? 'Incorrecto. Seguir√°s viendo esta pregunta.' : 'Incorrecto';
                resultTitle.style.color = '#dc2626';
            }

            // Convertir markdown b√°sico a HTML
            let formattedExplanation = currentQuestion.explanation
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **texto** -> <strong>texto</strong>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *texto* -> <em>texto</em>
                .replace(/\\n\\n/g, '<br><br>')                     // \n\n -> doble salto
                .replace(/\\n/g, '<br>')                            // \n -> salto simple
                .replace(/\n\n/g, '<br><br>')                       // saltos reales dobles
                .replace(/\n/g, '<br>')                             // saltos reales simples
                .replace(/‚Ä¢ /g, '<br>‚Ä¢ ')                           // bullets con salto
                .replace(/\.\s*(<br>)*\s*(üí°)/g, '.<br><br>üí°');   // Asegurar espacio antes de üí°

            resultExplanation.innerHTML = formattedExplanation;
            resultSection.style.display = 'block';

            document.getElementById('next-question-btn').style.display = 'block';
        }

        // ========================
        // ESTAD√çSTICAS
        // ========================

        function displayStats() {
            const container = document.getElementById('stats-container');

            if (Object.keys(userStats).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üìà</div>
                        <h3>¬°Comienza a estudiar!</h3>
                        <p>Aqu√≠ ver√°s tus estad√≠sticas una vez que respondas algunas preguntas.</p>
                    </div>
                `;
                return;
            }

            let statsHTML = '';

            // TABLA COMPACTA DE TODOS LOS TEMAS
            // Ordenar temas por n√∫mero (extraer n√∫mero del t√≠tulo "TEMA X - ...")
            const sortedTopics = Object.entries(userStats).sort(([idA, statsA], [idB, statsB]) => {
                const matchA = statsA.title.match(/TEMA\s+(\d+)/);
                const matchB = statsB.title.match(/TEMA\s+(\d+)/);
                const numA = matchA ? parseInt(matchA[1]) : 999;
                const numB = matchB ? parseInt(matchB[1]) : 999;
                return numA - numB;
            });

            // VISTA DESKTOP (tabla compacta)
            statsHTML += '<div class="topics-table-desktop" style="background: white; border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto;">';
            statsHTML += '<table style="width: 100%; border-collapse: collapse; min-width: 600px;">';
            statsHTML += '<thead style="background: #f9fafb;">';
            statsHTML += '<tr>';
            statsHTML += '<th style="padding: 8px 10px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #6b7280; font-size: 0.8rem;">Tema</th>';
            statsHTML += '<th style="padding: 8px 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #6b7280; font-size: 0.8rem;">Preguntas</th>';
            statsHTML += '<th style="padding: 8px 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #6b7280; font-size: 0.8rem;">Correctas</th>';
            statsHTML += '<th style="padding: 8px 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #6b7280; font-size: 0.8rem;">% Acierto</th>';
            statsHTML += '<th style="padding: 8px 10px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #6b7280; font-size: 0.8rem;">√öltima vez</th>';
            statsHTML += '</tr>';
            statsHTML += '</thead>';
            statsHTML += '<tbody>';

            sortedTopics.forEach(([topicId, stats], index) => {
                const accuracy = stats.accuracy || 0;
                const badgeColor = accuracy >= 80 ? '#22c55e' : accuracy >= 60 ? '#f59e0b' : '#ef4444';
                const lastStudied = new Date(stats.lastStudied).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const rowBg = index % 2 === 0 ? '#ffffff' : '#f9fafb';

                statsHTML += `
                    <tr style="border-bottom: 1px solid #f3f4f6; background: ${rowBg}; transition: background 0.2s ease;"
                        onmouseover="this.style.background='#f3f4f6';"
                        onmouseout="this.style.background='${rowBg}';">
                        <td style="padding: 8px 10px; font-weight: 600; color: #1f2937; font-size: 0.8rem;">${stats.title}</td>
                        <td style="padding: 8px 10px; text-align: center; color: #6b7280; font-size: 0.8rem;">${stats.totalQuestions}</td>
                        <td style="padding: 8px 10px; text-align: center; color: #6b7280; font-size: 0.8rem;">${stats.correctAnswers}</td>
                        <td style="padding: 8px 10px; text-align: center;">
                            <span style="background: ${badgeColor}; color: white; padding: 3px 10px; border-radius: 5px; font-weight: 600; font-size: 0.8rem; display: inline-block; min-width: 50px; text-align: center;">
                                ${Math.round(accuracy)}%
                            </span>
                        </td>
                        <td style="padding: 8px 10px; text-align: center; color: #6b7280; font-size: 0.75rem;">${lastStudied}</td>
                    </tr>
                `;
            });

            statsHTML += '</tbody>';
            statsHTML += '</table>';
            statsHTML += '</div>';

            // VISTA M√ìVIL (lista simple)
            statsHTML += '<div class="topics-table-mobile" style="display: none; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';

            sortedTopics.forEach(([topicId, stats], index) => {
                const accuracy = stats.accuracy || 0;
                const badgeColor = accuracy >= 80 ? '#22c55e' : accuracy >= 60 ? '#f59e0b' : '#ef4444';
                const lastStudied = new Date(stats.lastStudied).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';

                statsHTML += `
                    <div style="border-left: 4px solid ${badgeColor}; padding: 14px 16px; background: ${bgColor}; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-weight: 700; color: #1f2937; font-size: 0.95rem; flex: 1; padding-right: 10px; line-height: 1.3;">${stats.title}</div>
                            <div style="background: ${badgeColor}; color: white; padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 1rem; min-width: 65px; text-align: center;">
                                ${Math.round(accuracy)}%
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 0.85rem; color: #6b7280;">
                            <div><span style="font-weight: 600; color: #1f2937;">${stats.correctAnswers}/${stats.totalQuestions}</span> correctas</div>
                            <div>üìÖ ${lastStudied}</div>
                        </div>
                    </div>
                `;
            });

            statsHTML += '</div>';
            container.innerHTML = statsHTML;
        }

        // ========================
        // PREGUNTAS FALLADAS
        // ========================

        function displayFailedQuestions() {
            const container = document.getElementById('failed-container');

            if (Object.keys(failedQuestions).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üéØ</div>
                        <h3>¬°Excelente!</h3>
                        <p>No tienes preguntas falladas para repasar.</p>
                    </div>
                `;
                return;
            }

            // Separar examenes de temas normales
            const exams = [];
            const topics = [];

            Object.entries(failedQuestions).forEach(([topicId, topicData]) => {
                if (topicId.startsWith('examen-')) {
                    exams.push([topicId, topicData]);
                } else {
                    topics.push([topicId, topicData]);
                }
            });

            // Ordenar temas por n√∫mero (extraer n√∫mero del t√≠tulo "TEMA X - ...")
            topics.sort(([idA, dataA], [idB, dataB]) => {
                const titleA = dataA.title || '';
                const titleB = dataB.title || '';
                const matchA = titleA.match(/TEMA\s+(\d+)/);
                const matchB = titleB.match(/TEMA\s+(\d+)/);
                const numA = matchA ? parseInt(matchA[1]) : 999;
                const numB = matchB ? parseInt(matchB[1]) : 999;
                return numA - numB;
            });

            let failedHTML = '<div class="failed-topics">';

            // Mostrar EXAMENES primero (si hay)
            if (exams.length > 0) {
                failedHTML += `
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #1f2937; font-size: 1.25rem; margin-bottom: 16px; border-bottom: 2px solid #f97316; padding-bottom: 8px;">
                            üéì Examenes Oficiales
                        </h3>
                `;

                exams.forEach(([examId, examData]) => {
                    // Extraer info del examId: "examen-25-1730678400000"
                    const parts = examId.split('-');
                    const questionCount = examData.questions.length;
                    const examSize = parts[1] || '?';
                    const timestamp = parts[2] ? new Date(parseInt(parts[2])) : null;
                    const dateStr = timestamp ? timestamp.toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                    failedHTML += `
                        <div class="failed-topic-card" style="position: relative; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #fbbf24;">
                            <!-- Badge PDF superior derecho -->
                            <button onclick="exportToPDF('${examId}')" style="position: absolute; top: 16px; right: 16px; background: #fed7aa; color: #9a3412; padding: 6px 12px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: all 0.2s ease;" onmouseover="this.style.background='#fdba74'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(251, 146, 60, 0.3)';" onmouseout="this.style.background='#fed7aa'; this.style.transform='none'; this.style.boxShadow='none';">
                                üìÑ Exportar PDF
                            </button>

                            <div style="margin-bottom: 16px; padding-right: 120px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <h3 style="margin: 0; color: #92400e; font-size: 1.25rem;">Examen ${examSize} preguntas</h3>
                                    <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">OFICIAL</span>
                                </div>
                                <div style="color: #78350f; font-size: 0.75rem; margin-bottom: 4px;">
                                    üìÖ ${dateStr}
                                </div>
                                <div style="color: #dc2626; font-weight: 600; font-size: 0.875rem;">
                                    üìù ${questionCount} pregunta${questionCount !== 1 ? 's' : ''} fallada${questionCount !== 1 ? 's' : ''}
                                </div>
                            </div>
                            <button onclick="startReviewTest('${examId}')" style="width: 100%; background: #f59e0b; color: white; padding: 14px 24px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease;" onmouseover="this.style.background='#d97706'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';" onmouseout="this.style.background='#f59e0b'; this.style.transform='none'; this.style.boxShadow='none';">
                                üéØ Repasar Preguntas del Examen
                            </button>
                        </div>
                    `;
                });

                failedHTML += '</div>';
            }

            // Mostrar TEMAS normales (si hay)
            if (topics.length > 0) {
                if (exams.length > 0) {
                    failedHTML += `
                        <div style="margin-bottom: 32px;">
                            <h3 style="color: #1f2937; font-size: 1.25rem; margin-bottom: 16px; border-bottom: 2px solid #f97316; padding-bottom: 8px;">
                                üìö Temas de Estudio
                            </h3>
                    `;
                }

                topics.forEach(([topicId, topicData]) => {
                    const topicTitle = topicData.title || 'Tema';
                    const questionCount = topicData.questions.length;

                    failedHTML += `
                        <div class="failed-topic-card" style="position: relative; background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border: 1px solid #f3f4f6;">
                            <!-- Badge PDF superior derecho -->
                            <button onclick="exportToPDF('${topicId}')" style="position: absolute; top: 12px; right: 12px; background: #fed7aa; color: #9a3412; padding: 5px 10px; font-weight: 600; border: none; border-radius: 5px; cursor: pointer; font-size: 0.7rem; transition: all 0.2s ease;" onmouseover="this.style.background='#fdba74'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(251, 146, 60, 0.3)';" onmouseout="this.style.background='#fed7aa'; this.style.transform='none'; this.style.boxShadow='none';">
                                üìÑ Exportar PDF
                            </button>

                            <div style="margin-bottom: 12px; padding-right: 110px;">
                                <h3 style="margin: 0 0 6px 0; color: #1f2937; font-size: 1rem;">${topicTitle}</h3>
                                <div style="color: #dc2626; font-weight: 600; font-size: 0.8rem;">
                                    üìù ${questionCount} pregunta${questionCount !== 1 ? 's' : ''} para repasar
                                </div>
                            </div>

                            <button onclick="startReviewTest('${topicId}')" style="width: 100%; background: #f97316; color: white; padding: 10px 16px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease;" onmouseover="this.style.background='#ea580c'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(249, 115, 22, 0.3)';" onmouseout="this.style.background='#f97316'; this.style.transform='none'; this.style.boxShadow='none';">
                                üéØ Hacer Test de Repaso
                            </button>
                        </div>
                    `;
                });

                if (exams.length > 0) {
                    failedHTML += '</div>';
                }
            }

            failedHTML += '</div>';
            container.innerHTML = failedHTML;
        }

        // Nueva funci√≥n: Iniciar test de repaso
        async function startReviewTest(topicId) {
            try {
                console.log(`üéØ Iniciando test de repaso para tema: ${topicId}`);

                const response = await fetch(`${API_BASE}/api/review-exam/${topicId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al cargar preguntas de repaso');
                }

                const data = await response.json();

                // Iniciar el test con las preguntas de repaso
                currentTopic = topicId;
                window.reviewQuestions = data.questions;
                window.isReviewMode = true;
                window.currentReviewIndex = 0;

                // üî¥ FIX: Asegurar que NO est√° en modo examen oficial
                isOfficialExamMode = false;

                // Ocultar elementos del examen oficial
                document.getElementById('exam-progress-bar').style.display = 'none';
                document.getElementById('exam-progress-text').style.display = 'none';
                document.getElementById('exam-finish-container').style.display = 'none';

                currentQuestion = window.reviewQuestions[0];
                questionCount = 1;
                correctAnswers = 0;

                // Obtener el t√≠tulo del tema o examen
                let topicTitle;
                if (topicId.startsWith('examen-')) {
                    // Es un examen oficial
                    const parts = topicId.split('-');
                    const examSize = parts[1] || '?';
                    topicTitle = `üéì Examen ${examSize} preguntas`;
                } else {
                    // Es un tema normal
                    const topicConfig = availableTopics.find(([id]) => id === topicId);
                    topicTitle = topicConfig ? topicConfig[1].title : (failedQuestions[topicId]?.title || 'Test de Repaso');
                }

                document.getElementById('current-topic-name').textContent = topicTitle + ' - REPASO';
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${window.reviewQuestions.length}`;

                // Mostrar p√°gina de estudio y el contenedor de preguntas
                showPage('study');
                showQuestionMode();
                displayQuestion();

                console.log(`‚úÖ Test de repaso iniciado: ${data.questions.length} preguntas`);

            } catch (error) {
                console.error('Error iniciando test de repaso:', error);
                alert('Error al cargar el test de repaso. Intenta de nuevo.');
            }
        }

        // ========================
        // UTILIDADES
        // ========================

        function showLoading() {
            document.getElementById('question-text').innerHTML =
                `<div style="text-align: center; padding: 30px;">
                    <div class="loading"></div>
                    <p style="margin-top: 16px; color: #1f2937; font-weight: 600; font-size: 1rem;">Buscando las mejores preguntas...</p>
                    <p style="margin-top: 8px; color: #6b7280; font-size: 0.875rem;">Puede tardar unos segundos la primera vez</p>
                </div>`;
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'none';
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        function clearAllData() {
            if (confirm('¬øBorrar todos los datos de progreso?')) {
                localStorage.removeItem('oposicion_stats');
                localStorage.removeItem('oposicion_failed');
                userStats = {};
                failedQuestions = {};
                
                displayStats();
                displayFailedQuestions();
                
                showSuccess('Datos eliminados');
            }
        }

        // ========================
        // EXAMEN OFICIAL
        // ========================

        function saveOfficialExamAnswer(userAnswer) {
            const isCorrect = userAnswer === currentQuestion.correct;

            // Guardar respuesta en el array (sin mostrar feedback)
            officialExamAnswers.push({
                questionNumber: questionCount,
                question: currentQuestion.question,
                options: currentQuestion.options,
                userAnswer,
                correctAnswer: currentQuestion.correct,
                explanation: currentQuestion.explanation,
                isCorrect,
                difficulty: currentQuestion.difficulty,
                page_reference: currentQuestion.page_reference,
                timestamp: Date.now()
            });

            // Contar correctas para el resumen final
            if (isCorrect) correctAnswers++;

            // GUARDAR PROGRESO EN LOCALSTORAGE
            const examState = {
                questions: officialExamQuestions,
                answers: officialExamAnswers,
                currentQuestionIndex: questionCount, // Ya respondi√≥ esta, la siguiente ser√° questionCount + 1
                correctAnswers: correctAnswers,
                startTime: officialExamStartTime,
                questionCount: officialExamQuestions.length,
                timestamp: Date.now()
            };
            localStorage.setItem('official_exam_progress', JSON.stringify(examState));

            console.log(`üìù Respuesta guardada: Pregunta ${questionCount} - ${isCorrect ? 'Correcta ‚úÖ' : 'Incorrecta ‚ùå'}`);
            console.log(`üíæ Progreso guardado: ${questionCount}/${officialExamQuestions.length}`);

            // Actualizar barra de progreso
            updateExamProgress();
        }

        function updateExamProgress() {
            if (!isOfficialExamMode) return;

            const answered = officialExamAnswers.length;
            const total = officialExamQuestions.length;
            const percentage = (answered / total) * 100;

            // Actualizar barra
            document.getElementById('exam-progress-fill').style.width = `${percentage}%`;
            document.getElementById('exam-progress-current').textContent = answered;
            document.getElementById('exam-progress-total').textContent = total;

            // Mostrar bot√≥n de finalizar si respondi√≥ todas
            if (answered === total) {
                document.getElementById('exam-finish-container').style.display = 'block';
            }
        }

        function showFinishExamModal() {
            const answered = officialExamAnswers.length;
            const total = officialExamQuestions.length;

            document.getElementById('modal-exam-summary').textContent =
                `Has respondido las ${total} preguntas del examen. ¬øDeseas ver tus resultados?`;

            const modal = document.getElementById('finish-exam-modal');
            modal.style.display = 'flex';
        }

        function closeFinishExamModal() {
            document.getElementById('finish-exam-modal').style.display = 'none';
        }

        function confirmFinishExam() {
            closeFinishExamModal();
            finishOfficialExam();
        }

        function selectExamSize(size) {
            officialExamConfig.questionCount = size;
            document.querySelectorAll('.exam-size-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.size) === size) {
                    btn.classList.add('active');
                }
            });
        }

        async function startOfficialExam() {
            // TIMEOUT: 4.5 minutos para ex√°menes (sincronizado con backend 4min + 30s margen)
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 270000); // 4.5 minutos (270s)

            try {
                console.log(`üéì Iniciando examen oficial: ${officialExamConfig.questionCount} preguntas`);

                // Mostrar loading en la p√°gina de configuraci√≥n
                const startBtn = document.getElementById('start-exam-btn');
                const loadingDiv = document.getElementById('exam-loading');

                startBtn.disabled = true;
                startBtn.style.opacity = '0.5';
                startBtn.style.cursor = 'not-allowed';
                loadingDiv.style.display = 'block';

                // Solicitar examen al servidor
                const response = await fetch(`${API_BASE}/api/exam/official`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionCount: officialExamConfig.questionCount
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout); // Limpiar timeout si se complet√≥ antes

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    throw new Error(errorData.error || `Error del servidor: ${response.status}`);
                }

                const data = await response.json();

                // üî¥ FIX: Filtrar preguntas de error t√©cnico antes de configurar el examen
                const validQuestions = data.questions.filter(q => {
                    return !q.question.includes('ERROR T√âCNICO') &&
                           !q.question.includes('‚ö†Ô∏è') &&
                           !q.question.includes('No se pudo generar una pregunta v√°lida');
                });

                console.log(`üìù Preguntas v√°lidas: ${validQuestions.length} de ${data.questions.length}`);

                // Verificar que tengamos suficientes preguntas v√°lidas
                if (validQuestions.length === 0) {
                    throw new Error('No se pudieron generar preguntas v√°lidas. Por favor, intenta de nuevo.');
                }

                if (validQuestions.length < officialExamConfig.questionCount * 0.8) {
                    console.warn(`‚ö†Ô∏è Solo se generaron ${validQuestions.length} preguntas v√°lidas de ${officialExamConfig.questionCount} solicitadas`);
                }

                // Configurar examen con preguntas v√°lidas
                officialExamQuestions = validQuestions;
                isOfficialExamMode = true;
                officialExamStartTime = Date.now();
                officialExamAnswers = [];
                questionCount = 1;
                correctAnswers = 0;
                currentQuestion = officialExamQuestions[0];

                // GUARDAR ESTADO INICIAL EN LOCALSTORAGE
                const initialExamState = {
                    questions: officialExamQuestions,
                    answers: [],
                    currentQuestionIndex: 0, // A√∫n no ha respondido ninguna
                    correctAnswers: 0,
                    startTime: officialExamStartTime,
                    questionCount: officialExamQuestions.length,
                    timestamp: Date.now()
                };
                localStorage.setItem('official_exam_progress', JSON.stringify(initialExamState));
                console.log('üíæ Estado inicial del examen guardado');

                // Mostrar primera pregunta
                showPage('study');
                showQuestionMode();

                // Usar setTimeout para asegurar que los elementos existen despu√©s de showPage
                setTimeout(() => {
                    const topicName = document.getElementById('current-topic-name');
                    const questionNumber = document.getElementById('question-number');
                    const progressBar = document.getElementById('exam-progress-bar');
                    const progressText = document.getElementById('exam-progress-text');
                    const progressTotal = document.getElementById('exam-progress-total');
                    const progressCurrent = document.getElementById('exam-progress-current');

                    if (topicName) topicName.textContent = 'üéì EXAMEN OFICIAL';
                    if (questionNumber) questionNumber.textContent = `Pregunta ${questionCount} de ${officialExamQuestions.length}`;
                    if (progressBar) progressBar.style.display = 'block';
                    if (progressText) progressText.style.display = 'block';
                    if (progressTotal) progressTotal.textContent = officialExamQuestions.length;
                    if (progressCurrent) progressCurrent.textContent = '0';

                    console.log(`‚úÖ Examen oficial iniciado: ${officialExamQuestions.length} preguntas`);
                }, 100);

                displayQuestion();

            } catch (error) {
                clearTimeout(timeout); // Asegurar limpieza del timeout en caso de error

                // Manejar timeout espec√≠ficamente
                if (error.name === 'AbortError') {
                    console.error('‚è∞ TIMEOUT: El examen tard√≥ m√°s de 10 minutos en generarse');
                    alert('‚è∞ El examen est√° tardando demasiado en generarse.\n\nPor favor, intenta nuevamente con menos preguntas o espera unos minutos.');
                } else {
                    console.error('Error iniciando examen oficial:', error);
                    console.error('Error completo:', error.message, error.stack);
                    alert(`Error al generar examen oficial:\n${error.message}\n\nRevisa la consola para m√°s detalles.`);
                }

                // Restaurar bot√≥n y ocultar loading en caso de error
                const startBtn = document.getElementById('start-exam-btn');
                const loadingDiv = document.getElementById('exam-loading');

                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.style.opacity = '1';
                    startBtn.style.cursor = 'pointer';
                }
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }

        async function finishOfficialExam() {

            const totalQuestions = officialExamQuestions.length;
            const answeredQuestions = officialExamAnswers.length;
            const correctCount = officialExamAnswers.filter(a => a.isCorrect).length;
            const incorrectCount = totalQuestions - correctCount;
            const nota = (correctCount / totalQuestions) * 10;

            // Crear identificador √∫nico del examen
            const examId = `examen-${totalQuestions}-${Date.now()}`;
            const examName = `Examen ${totalQuestions} preguntas`;

            // Guardar preguntas falladas en la base de datos
            const failedAnswers = officialExamAnswers.filter(a => !a.isCorrect);
            if (failedAnswers.length > 0) {
                try {
                    const response = await fetch('/api/exam/save-failed', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            examId,
                            examName,
                            failedQuestions: failedAnswers
                        })
                    });

                    if (response.ok) {
                        console.log(`‚úÖ ${failedAnswers.length} preguntas falladas guardadas en repaso`);
                        // Recargar datos del usuario para actualizar contador de repaso
                        await loadUserData();
                    }
                } catch (error) {
                    console.error('Error guardando preguntas falladas:', error);
                }
            }

            // Generar HTML con todas las respuestas
            let answersHTML = '';
            officialExamAnswers.forEach((answer, index) => {
                const isCorrect = answer.isCorrect;
                const bgColor = isCorrect ? '#f0fdf4' : '#fef2f2';
                const borderColor = isCorrect ? '#16a34a' : '#dc2626';
                const icon = isCorrect ? '‚úÖ' : '‚ùå';

                answersHTML += `
                    <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="font-size: 1.5rem;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Pregunta ${answer.questionNumber}</div>
                                <div style="margin-bottom: 8px; color: #374151;">${answer.question}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    <div style="margin-bottom: 4px;">
                                        <strong>Tu respuesta:</strong> ${answer.options[answer.userAnswer]} ${!isCorrect ? '‚ùå' : ''}
                                    </div>
                                    ${!isCorrect ? `<div style="margin-bottom: 4px;"><strong>Correcta:</strong> ${answer.options[answer.correctAnswer]} ‚úÖ</div>` : ''}
                                    <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                                        <strong>Explicaci√≥n:</strong> ${answer.explanation
                                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                            .replace(/\\n\\n/g, '<br><br>')
                                            .replace(/\\n/g, '<br>')
                                            .replace(/\n\n/g, '<br><br>')
                                            .replace(/\n/g, '<br>')
                                            .replace(/‚Ä¢ /g, '<br>‚Ä¢ ')
                                            .replace(/\.\s*(<br>)*\s*(üí°)/g, '.<br><br>üí°')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Mostrar resultados
            const resultHTML = `
                <div class="card" style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">
                        ${nota >= 5 ? 'üéâ' : 'üìö'}
                    </div>
                    <h2 style="margin-bottom: 8px;">
                        ‚úÖ Examen Finalizado
                    </h2>
                    <div style="font-size: 3rem; font-weight: bold; color: ${nota >= 5 ? '#16a34a' : '#dc2626'}; margin: 24px 0;">
                        ${nota.toFixed(2)} / 10
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 32px 0; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #16a34a;">${correctCount}</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Correctas</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${incorrectCount}</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Incorrectas</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #f97316;">${totalQuestions}</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Total</div>
                        </div>
                    </div>
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin: 24px 0;">
                        <div style="font-weight: 600; margin-bottom: 8px;">üìä Estad√≠sticas</div>
                        <div style="display: flex; justify-content: space-around; font-size: 0.875rem; color: #6b7280;">
                            <div>Precisi√≥n: ${((correctCount / totalQuestions) * 100).toFixed(1)}%</div>
                            <div>Total: ${totalQuestions} preguntas</div>
                        </div>
                        ${incorrectCount > 0 ? `
                            <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 0.875rem; color: #92400e;">
                                üíæ Se han guardado ${incorrectCount} pregunta${incorrectCount > 1 ? 's' : ''} fallada${incorrectCount > 1 ? 's' : ''} en <strong>Reforzar</strong> como "${examName}"
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 style="margin-bottom: 16px;">üìã Revisi√≥n de Respuestas</h3>
                    <div style="max-height: 600px; overflow-y: auto;">
                        ${answersHTML}
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <button id="exit-exam-btn" style="width: 100%; background: #f97316; color: white; padding: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 1.125rem;">
                        üè† Volver al Inicio
                    </button>
                </div>
            `;

            // üî¥ FIX: Asegurar que estamos en la p√°gina correcta para ver resultados
            // Esto previene que accidentalmente cambies de p√°gina y pierdas los resultados
            showPage('study');

            document.getElementById('topic-selection').style.display = 'none';
            document.getElementById('question-container').innerHTML = resultHTML;
            document.getElementById('question-container').classList.remove('hidden');

            // üî¥ FIX: Agregar event listener al bot√≥n "Volver al Inicio" despu√©s de insertar el HTML
            setTimeout(() => {
                const exitBtn = document.getElementById('exit-exam-btn');
                if (exitBtn) {
                    exitBtn.addEventListener('click', exitOfficialExam);
                    console.log('‚úÖ Event listener agregado al bot√≥n Volver al Inicio');
                } else {
                    console.error('‚ùå No se encontr√≥ el bot√≥n exit-exam-btn');
                }
            }, 100);

            // Resetear variables
            isOfficialExamMode = false;
            officialExamQuestions = [];
            officialExamAnswers = [];

            // LIMPIAR PROGRESO GUARDADO
            localStorage.removeItem('official_exam_progress');
            console.log('üóëÔ∏è Progreso del examen eliminado de localStorage');

            // Ocultar elementos del examen (con validaci√≥n)
            const progressBar = document.getElementById('exam-progress-bar');
            const progressText = document.getElementById('exam-progress-text');
            const finishContainer = document.getElementById('exam-finish-container');

            if (progressBar) progressBar.style.display = 'none';
            if (progressText) progressText.style.display = 'none';
            if (finishContainer) finishContainer.style.display = 'none';

            // üî¥ FIX: Deshabilitar temporalmente los botones de navegaci√≥n para evitar cambios accidentales
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.5';
            });

            console.log('üìä Resultados del examen mostrados. Navegaci√≥n deshabilitada para evitar p√©rdida de resultados.');
        }

        function exitOfficialExam() {
            isOfficialExamMode = false;
            officialExamQuestions = [];
            officialExamAnswers = [];

            // Restaurar bot√≥n y ocultar loading
            const startBtn = document.getElementById('start-exam-btn');
            const loadingDiv = document.getElementById('exam-loading');

            if (startBtn) {
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
            }
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            // Ocultar elementos del examen (con validaci√≥n)
            const progressBar = document.getElementById('exam-progress-bar');
            const progressText = document.getElementById('exam-progress-text');
            const finishContainer = document.getElementById('exam-finish-container');

            if (progressBar) progressBar.style.display = 'none';
            if (progressText) progressText.style.display = 'none';
            if (finishContainer) finishContainer.style.display = 'none';

            // üî¥ FIX: Re-habilitar botones de navegaci√≥n
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            });

            // Limpiar el contenedor de preguntas
            const questionContainer = document.getElementById('question-container');
            if (questionContainer) {
                questionContainer.innerHTML = '';
                questionContainer.classList.add('hidden');
            }

            showPage('study'); // üî¥ FIX: Volver a la p√°gina de Estudiar en lugar de Examen Oficial
        }

        // Detectar examen pendiente y mostrar banner
        function checkPendingExam() {
            // Siempre restaurar bot√≥n y ocultar loading al entrar a esta p√°gina
            const startBtn = document.getElementById('start-exam-btn');
            const loadingDiv = document.getElementById('exam-loading');

            if (startBtn) {
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
            }
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            const savedProgress = localStorage.getItem('official_exam_progress');

            if (savedProgress) {
                try {
                    const examState = JSON.parse(savedProgress);
                    const answered = examState.currentQuestionIndex;
                    const total = examState.questionCount;

                    // Mostrar banner
                    document.getElementById('pending-exam-banner').style.display = 'block';
                    document.getElementById('pending-exam-info').textContent =
                        `Respondiste ${answered} de ${total} preguntas`;

                    console.log(`üìù Examen pendiente detectado: ${answered}/${total}`);
                } catch (error) {
                    console.error('Error leyendo examen pendiente:', error);
                    localStorage.removeItem('official_exam_progress');
                }
            } else {
                document.getElementById('pending-exam-banner').style.display = 'none';
            }
        }

        // Continuar examen pendiente
        function continueOfficialExam() {
            const savedProgress = localStorage.getItem('official_exam_progress');

            if (!savedProgress) {
                alert('No se encontr√≥ el examen pendiente.');
                return;
            }

            try {
                const examState = JSON.parse(savedProgress);

                // Restaurar estado completo
                officialExamQuestions = examState.questions;
                officialExamAnswers = examState.answers;
                questionCount = examState.currentQuestionIndex + 1; // Siguiente pregunta
                correctAnswers = examState.correctAnswers;
                officialExamStartTime = examState.startTime;
                isOfficialExamMode = true;

                // Verificar si ya termin√≥ todas las preguntas
                if (questionCount > officialExamQuestions.length) {
                    finishOfficialExam();
                    return;
                }

                // Cargar la siguiente pregunta
                currentQuestion = officialExamQuestions[questionCount - 1];

                // Ir a la p√°gina de estudio y mostrar la pregunta
                showPage('study');
                showQuestionMode();
                document.getElementById('current-topic-name').textContent = 'üéì EXAMEN OFICIAL';
                document.getElementById('question-number').textContent =
                    `Pregunta ${questionCount} de ${officialExamQuestions.length}`;
                displayQuestion();

                // Mostrar y actualizar barra de progreso
                document.getElementById('exam-progress-bar').style.display = 'block';
                document.getElementById('exam-progress-text').style.display = 'block';
                updateExamProgress();

                console.log(`‚úÖ Examen restaurado: Continuando desde pregunta ${questionCount}`);
            } catch (error) {
                console.error('Error restaurando examen:', error);
                alert('Error al restaurar el examen. Se eliminar√° el progreso.');
                localStorage.removeItem('official_exam_progress');
                checkPendingExam();
            }
        }

        // Cancelar examen pendiente
        function cancelPendingExam() {
            if (confirm('¬øEst√°s seguro? Se perder√° todo el progreso del examen actual.')) {
                // Limpiar localStorage
                localStorage.removeItem('official_exam_progress');

                // üî¥ FIX: Resetear variables globales del examen
                isOfficialExamMode = false;
                officialExamQuestions = [];
                officialExamAnswers = [];

                // üî¥ FIX: Ocultar elementos visuales del examen
                document.getElementById('exam-progress-bar').style.display = 'none';
                document.getElementById('exam-progress-text').style.display = 'none';
                document.getElementById('exam-finish-container').style.display = 'none';

                checkPendingExam();
                console.log('‚ùå Examen pendiente cancelado y variables reseteadas');
            }
        }

        // ========================
        // INICIALIZACI√ìN
        // ========================

        window.onload = async function() {
            console.log('üöÄ Iniciando aplicaci√≥n...');

            // Configurar monitoreo de conexi√≥n
            setupConnectionMonitoring();

            // Primero verificar autenticaci√≥n
            const authenticated = await checkAuth();

            if (authenticated) {
                // Solo cargar la app si est√° autenticado
                await checkServerHealth();
                await loadUserData();
                showPage('study');
                console.log('‚úÖ Aplicaci√≥n iniciada');
            } else {
                console.log('‚è≥ Esperando autenticaci√≥n...');
            }
        };

        // ========================
        // MONITOREO DE CONEXI√ìN
        // ========================

        function setupConnectionMonitoring() {
            const statusBanner = document.getElementById('connection-status');
            const statusIcon = document.getElementById('connection-status-icon');
            const statusText = document.getElementById('connection-status-text');

            // Mostrar banner cuando se pierde la conexi√≥n
            window.addEventListener('offline', () => {
                console.log('üî¥ Conexi√≥n perdida');
                statusBanner.style.display = 'flex';
                statusBanner.style.background = '#ef4444';
                statusIcon.textContent = 'üì°';
                statusText.textContent = 'Sin conexi√≥n - tus respuestas est√°n guardadas localmente';
            });

            // Ocultar banner cuando se recupera la conexi√≥n
            window.addEventListener('online', () => {
                console.log('üü¢ Conexi√≥n recuperada');
                statusBanner.style.background = '#10b981';
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'Conexi√≥n recuperada';

                // Ocultar banner despu√©s de 3 segundos
                setTimeout(() => {
                    statusBanner.style.display = 'none';
                }, 3000);
            });

            // Verificar estado inicial
            if (!navigator.onLine) {
                statusBanner.style.display = 'flex';
            }
        }

        // ========================
        // ESTAD√çSTICAS SEMANALES PDF
        // ========================

        function showWeeklyStatsModal() {
            const modal = document.getElementById('weekly-stats-modal');
            modal.style.display = 'flex';
        }

        function closeWeeklyStatsModal() {
            const modal = document.getElementById('weekly-stats-modal');
            modal.style.display = 'none';
        }

        async function exportWeeklyStatsToPDF(weeks) {
            try {
                console.log(`üìä Exportando estad√≠sticas semanales (${weeks} semanas)...`);
                closeWeeklyStatsModal();

                // Fetch data from API
                const url = weeks === 0
                    ? `${API_BASE}/api/weekly-stats?weeks=1000`
                    : `${API_BASE}/api/weekly-stats?weeks=${weeks}`;

                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error cargando estad√≠sticas semanales');
                }

                const data = await response.json();

                if (!data.summary || data.summary.length === 0) {
                    alert('No hay datos disponibles para el per√≠odo seleccionado');
                    return;
                }

                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = 20;

                // T√≠tulo
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                const titleText = weeks === 0 ? 'Estad√≠sticas - Todo el Historial' : `Estad√≠sticas - √öltimas ${weeks} Semanas`;
                doc.text(titleText, margin, yPos);
                yPos += 8;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(107, 114, 128);
                doc.text(`Generado: ${new Date().toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                })}`, margin, yPos);
                yPos += 12;

                // Resumen general
                const totalQuestions = data.summary.reduce((sum, w) => sum + w.total_questions, 0);
                const totalCorrect = data.summary.reduce((sum, w) => sum + w.correct_answers, 0);
                const avgAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(31, 41, 55);
                doc.text('RESUMEN GENERAL', margin, yPos);
                yPos += 7;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(75, 85, 99);
                doc.text(`Total de preguntas: ${totalQuestions}`, margin + 5, yPos);
                yPos += 5;
                doc.text(`Respuestas correctas: ${totalCorrect}`, margin + 5, yPos);
                yPos += 5;
                doc.text(`Porcentaje de acierto: ${avgAccuracy}%`, margin + 5, yPos);
                yPos += 10;

                // L√≠nea separadora
                doc.setLineWidth(0.5);
                doc.setDrawColor(229, 231, 235);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;

                // Tabla de resumen por semanas
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(31, 41, 55);
                doc.text('RESUMEN POR SEMANA', margin, yPos);
                yPos += 8;

                // Encabezados de tabla
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(107, 114, 128);
                doc.setFillColor(249, 250, 251);
                doc.rect(margin, yPos - 5, pageWidth - (2 * margin), 8, 'F');

                doc.text('Semana', margin + 3, yPos);
                doc.text('Preguntas', pageWidth - margin - 95, yPos);
                doc.text('Correctas', pageWidth - margin - 65, yPos);
                doc.text('% Acierto', pageWidth - margin - 35, yPos);
                yPos += 8;

                // Datos de semanas
                doc.setFont(undefined, 'normal');
                doc.setTextColor(31, 41, 55);

                data.summary.forEach((week, index) => {
                    if (yPos > pageHeight - 30) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const weekDate = new Date(week.week_start);
                    const weekStr = weekDate.toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'short'
                    });
                    const accuracy = Math.round(week.accuracy);

                    // Fila alternada
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(margin, yPos - 5, pageWidth - (2 * margin), 7, 'F');
                    }

                    doc.text(weekStr, margin + 3, yPos);
                    doc.text(String(week.total_questions), pageWidth - margin - 88, yPos);
                    doc.text(String(week.correct_answers), pageWidth - margin - 60, yPos);

                    // Color seg√∫n accuracy
                    const accuracyColor = accuracy >= 80 ? [34, 197, 94] : accuracy >= 60 ? [245, 158, 11] : [239, 68, 68];
                    doc.setTextColor(...accuracyColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${accuracy}%`, pageWidth - margin - 28, yPos);
                    doc.setTextColor(31, 41, 55);
                    doc.setFont(undefined, 'normal');

                    yPos += 7;
                });

                yPos += 5;

                // Desglose por tema (si hay datos)
                if (data.byTopic && data.byTopic.length > 0) {
                    if (yPos > pageHeight - 60) {
                        doc.addPage();
                        yPos = 20;
                    }

                    // L√≠nea separadora
                    doc.setLineWidth(0.5);
                    doc.setDrawColor(229, 231, 235);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;

                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(31, 41, 55);
                    doc.text('DESGLOSE POR TEMA Y SEMANA', margin, yPos);
                    yPos += 8;

                    // üî¥ FIX: Agrupar por SEMANA primero, luego por tema
                    const byWeekMap = {};
                    data.byTopic.forEach(entry => {
                        const weekKey = entry.week_start; // Usar week_start como clave
                        if (!byWeekMap[weekKey]) {
                            byWeekMap[weekKey] = {
                                week_start: entry.week_start,
                                topics: {}
                            };
                        }

                        if (!byWeekMap[weekKey].topics[entry.topic_id]) {
                            byWeekMap[weekKey].topics[entry.topic_id] = {
                                title: entry.topic_title,
                                total: 0,
                                correct: 0
                            };
                        }

                        byWeekMap[weekKey].topics[entry.topic_id].total += entry.total_questions;
                        byWeekMap[weekKey].topics[entry.topic_id].correct += entry.correct_answers;
                    });

                    // üî¥ FIX: Iterar por SEMANA primero, luego por tema
                    // Ordenar semanas por fecha (m√°s reciente primero)
                    const sortedWeeks = Object.entries(byWeekMap).sort(([dateA], [dateB]) => {
                        return new Date(dateB) - new Date(dateA);
                    });

                    sortedWeeks.forEach(([weekStart, weekData]) => {
                        // Verificar si necesitamos nueva p√°gina
                        if (yPos > pageHeight - 60) {
                            doc.addPage();
                            yPos = 20;
                        }

                        // T√≠tulo de la semana (sin emoji para compatibilidad PDF)
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(79, 70, 229); // Color morado para semana
                        const weekDate = new Date(weekStart);
                        const weekStr = weekDate.toLocaleDateString('es-ES', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });
                        doc.text(`Semana del ${weekStr}`, margin, yPos);
                        yPos += 6;

                        // Encabezados de tabla
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(107, 114, 128);
                        doc.setFillColor(249, 250, 251);
                        doc.rect(margin, yPos - 5, pageWidth - (2 * margin), 8, 'F');

                        doc.text('Tema', margin + 3, yPos);
                        doc.text('Preguntas', pageWidth - margin - 65, yPos);
                        doc.text('% Acierto', pageWidth - margin - 35, yPos);
                        yPos += 8;

                        // Ordenar temas por n√∫mero
                        const sortedTopics = Object.entries(weekData.topics).sort(([idA, infoA], [idB, infoB]) => {
                            const matchA = infoA.title.match(/TEMA\s+(\d+)/);
                            const matchB = infoB.title.match(/TEMA\s+(\d+)/);
                            const numA = matchA ? parseInt(matchA[1]) : 999;
                            const numB = matchB ? parseInt(matchB[1]) : 999;
                            return numA - numB;
                        });

                        // Datos por tema de esta semana
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(31, 41, 55);

                        let topicIndex = 0;
                        sortedTopics.forEach(([topicId, topicInfo]) => {
                            if (yPos > pageHeight - 20) {
                                doc.addPage();
                                yPos = 20;
                                topicIndex = 0;
                            }

                            const avgAccuracy = topicInfo.total > 0
                                ? Math.round((topicInfo.correct / topicInfo.total) * 100)
                                : 0;

                            // Fila alternada
                            if (topicIndex % 2 === 0) {
                                doc.setFillColor(249, 250, 251);
                                doc.rect(margin, yPos - 5, pageWidth - (2 * margin), 7, 'F');
                            }

                            // Acortar t√≠tulo si es muy largo
                            const maxTitleWidth = pageWidth - margin - 80;
                            let titleText = topicInfo.title;
                            if (doc.getTextWidth(titleText) > maxTitleWidth) {
                                while (doc.getTextWidth(titleText + '...') > maxTitleWidth && titleText.length > 10) {
                                    titleText = titleText.slice(0, -1);
                                }
                                titleText += '...';
                            }

                            doc.setFontSize(8);
                            doc.text(titleText, margin + 3, yPos);
                            doc.setFontSize(9);
                            doc.text(String(topicInfo.total), pageWidth - margin - 57, yPos);

                            // Color seg√∫n accuracy
                            const accuracyColor = avgAccuracy >= 80 ? [34, 197, 94] : avgAccuracy >= 60 ? [245, 158, 11] : [239, 68, 68];
                            doc.setTextColor(...accuracyColor);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${avgAccuracy}%`, pageWidth - margin - 28, yPos);
                            doc.setTextColor(31, 41, 55);
                            doc.setFont(undefined, 'normal');

                            yPos += 7;
                            topicIndex++;
                        });

                        // L√≠nea separadora entre semanas
                        yPos += 3;
                        doc.setLineWidth(0.3);
                        doc.setDrawColor(209, 213, 219); // Gris claro
                        doc.line(margin, yPos, pageWidth - margin, yPos);
                        yPos += 5; // Espacio adicional entre semanas
                    });
                }

                // Descargar PDF
                const fileName = weeks === 0
                    ? 'estadisticas_completo.pdf'
                    : `estadisticas_${weeks}_semanas.pdf`;
                doc.save(fileName);

                console.log('‚úÖ PDF de estad√≠sticas generado y descargado');
            } catch (error) {
                console.error('‚ùå Error generando PDF de estad√≠sticas:', error);
                alert('Error al generar el PDF de estad√≠sticas. Verifica que tengas datos registrados.');
            }
        }

        // ========================
        // EXPORTAR PREGUNTAS FALLADAS A PDF
        // ========================

        // Helper function para normalizar texto para jsPDF
        function normalizeTextForPDF(text) {
            if (!text) return '';

            // Primero normalizar caracteres especiales comunes
            let normalized = text
                .replace(/[""]/g, '"')
                .replace(/['']/g, "'")
                .replace(/‚Ä¶/g, '...')
                .replace(/‚Äì/g, '-')
                .replace(/‚Äî/g, '-');

            // Normalizar caracteres con acentos y diacr√≠ticos para evitar problemas de encoding en jsPDF
            // Usar NFD (Normalization Form Decomposed) para separar base + diacr√≠tico, luego eliminar diacr√≠ticos
            normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            // Eliminar emojis y caracteres Unicode especiales que causan s√≠mbolos raros en jsPDF
            // Mantener solo caracteres ASCII b√°sicos, n√∫meros, puntuaci√≥n y espacios
            normalized = normalized.replace(/[^\x00-\x7F]/g, '');

            return normalized;
        }

        async function exportToPDF(topicId) {
            try {
                console.log(`üìÑ Exportando preguntas falladas de ${topicId} a PDF...`);

                const topicData = failedQuestions[topicId];
                if (!topicData || !topicData.questions || topicData.questions.length === 0) {
                    alert('No hay preguntas para exportar');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const maxWidth = pageWidth - (2 * margin);
                let yPos = 20;

                // T√≠tulo
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(topicData.title || 'Preguntas Falladas', margin, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Total: ${topicData.questions.length} preguntas`, margin, yPos);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, pageWidth - margin - 50, yPos);
                yPos += 10;

                // L√≠nea separadora
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;

                // Procesar cada pregunta
                topicData.questions.forEach((q, index) => {
                    // Verificar si necesitamos nueva p√°gina
                    if (yPos > pageHeight - 60) {
                        doc.addPage();
                        yPos = 20;
                    }

                    // N√∫mero de pregunta
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Pregunta ${index + 1}:`, margin, yPos);
                    yPos += 7;

                    // Texto de la pregunta
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const questionLines = doc.splitTextToSize(normalizeTextForPDF(q.question), maxWidth);
                    doc.text(questionLines, margin, yPos);
                    yPos += (questionLines.length * 5) + 5;

                    // Opciones
                    try {
                        const options = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
                        options.forEach((opt, optIndex) => {
                            const isCorrect = optIndex === q.correct;
                            const wasSelected = optIndex === q.user_answer;

                            if (isCorrect) doc.setTextColor(34, 197, 94); // Verde
                            else if (wasSelected) doc.setTextColor(239, 68, 68); // Rojo
                            else doc.setTextColor(107, 114, 128); // Gris

                            doc.setFont(undefined, isCorrect ? 'bold' : 'normal');

                            // Split SIN el prefijo para evitar problemas de encoding
                            const optLines = doc.splitTextToSize(normalizeTextForPDF(opt), maxWidth - 10);

                            // Agregar prefijo solo a respuesta del usuario (no a correcta, solo color)
                            let prefix = '  ';
                            if (wasSelected && !isCorrect) prefix = '[TU RESPUESTA] ';

                            // Primera l√≠nea con prefijo (si aplica)
                            doc.text(normalizeTextForPDF(prefix + optLines[0]), margin + 5, yPos);
                            yPos += 5;

                            // Resto de l√≠neas sin prefijo (indentadas)
                            for (let i = 1; i < optLines.length; i++) {
                                doc.text(normalizeTextForPDF(optLines[i]), margin + 5, yPos);
                                yPos += 5;
                            }

                            yPos += 2;
                        });
                    } catch (e) {
                        console.error('Error procesando opciones:', e);
                    }

                    doc.setTextColor(0, 0, 0); // Reset color
                    yPos += 3;

                    // Explicaci√≥n
                    if (q.explanation) {
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(75, 85, 99);
                        // Limpiar markdown para PDF
                        const cleanExplanation = q.explanation
                            .replace(/\*\*(.*?)\*\*/g, '$1')  // Eliminar **
                            .replace(/\*(.*?)\*/g, '$1')      // Eliminar *
                            .replace(/\\n/g, ' ')             // Convertir \n a espacio
                            .replace(/\n/g, ' ');             // Convertir saltos reales a espacio
                        // Normalizar TODO el texto (incluido el prefijo) ANTES de splitTextToSize
                        const explText = normalizeTextForPDF(`Explicacion: ${cleanExplanation}`);
                        const explLines = doc.splitTextToSize(explText, maxWidth);
                        doc.text(explLines, margin, yPos);
                        yPos += (explLines.length * 4) + 8;
                        doc.setTextColor(0, 0, 0);
                    } else {
                        yPos += 5;
                    }

                    // L√≠nea separadora entre preguntas
                    if (index < topicData.questions.length - 1) {
                        doc.setLineWidth(0.2);
                        doc.setDrawColor(229, 231, 235);
                        doc.line(margin, yPos, pageWidth - margin, yPos);
                        yPos += 10;
                    }
                });

                // Descargar PDF
                const fileName = `${topicData.title.replace(/[^a-z0-9]/gi, '_')}_falladas.pdf`;
                doc.save(fileName);

                console.log('‚úÖ PDF generado y descargado');
            } catch (error) {
                console.error('‚ùå Error generando PDF:', error);
                alert('Error al generar el PDF. Por favor intenta de nuevo.');
            }
        }

        // ========================
        // ESTAD√çSTICAS SEMANALES
        // ========================

    </script>

    <!-- Modal de Selecci√≥n de Rango Estad√≠sticas Semanales -->
    <div id="weekly-stats-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 4rem; margin-bottom: 16px;">üìä</div>
                <h2 style="margin: 0 0 12px 0; color: #1f2937;">Estad√≠sticas Semanales</h2>
                <p style="color: #6b7280; margin: 0; line-height: 1.6;">
                    Selecciona el per√≠odo de tiempo para el informe PDF
                </p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <button onclick="exportWeeklyStatsToPDF(1)" style="background: #f3f4f6; color: #374151; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
                    1 Semana
                </button>
                <button onclick="exportWeeklyStatsToPDF(2)" style="background: #f3f4f6; color: #374151; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
                    2 Semanas
                </button>
                <button onclick="exportWeeklyStatsToPDF(4)" style="background: #3b82f6; color: white; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
                    4 Semanas
                </button>
                <button onclick="exportWeeklyStatsToPDF(8)" style="background: #f3f4f6; color: #374151; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
                    8 Semanas
                </button>
                <button onclick="exportWeeklyStatsToPDF(12)" style="background: #f3f4f6; color: #374151; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
                    12 Semanas
                </button>
                <button onclick="exportWeeklyStatsToPDF(0)" style="background: #f3f4f6; color: #374151; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
                    Todo el historial
                </button>
            </div>
            <button onclick="closeWeeklyStatsModal()" style="width: 100%; background: #ef4444; color: white; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" onmouseover="this.style.background='#dc2626';" onmouseout="this.style.background='#ef4444';">
                ‚ùå Cancelar
            </button>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Finalizar Examen -->
    <div id="finish-exam-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 4rem; margin-bottom: 16px;">üìù</div>
                <h2 style="margin: 0 0 12px 0; color: #1f2937;">¬øFinalizar Examen?</h2>
                <p id="modal-exam-summary" style="color: #6b7280; margin: 0; line-height: 1.6;">
                    Has respondido X de Y preguntas
                </p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="closeFinishExamModal()" style="background: #f3f4f6; color: #374151; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.2s;">
                    ‚ùå Cancelar
                </button>
                <button onclick="confirmFinishExam()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 14px 20px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                    ‚úÖ Finalizar
                </button>
            </div>
        </div>
    </div>

    <!-- Banner de estado de conexi√≥n -->
    <div id="connection-status" style="display: none; position: fixed; bottom: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; font-weight: 600; font-size: 0.875rem;">
        <span id="connection-status-icon">üì°</span>
        <span id="connection-status-text">Sin conexi√≥n</span>
    </div>
</body>
</html>